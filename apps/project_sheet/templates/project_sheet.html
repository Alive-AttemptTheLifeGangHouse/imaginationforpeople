{% extends "project_sheet/project_base.html" %}

{% load i18n %}
{% load localeurl_tags %}
{% load tagging_tags %}

{% block extra_head %}
  {{ block.super }}
	<link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}/css/jquery/jquery.ui.autocomplete.tagit.css" media="screen, projection" />
	<link rel="stylesheet" href="{{ MEDIA_URL }}/css/anythingslider.css" type="text/css" media="screen" />

	<!-- inline  -->
	<script type="text/javascript" src="{{ MEDIA_URL }}/js/jquery/jquery.jeditable.js"></script>

	<!-- for tags -->
	<script type="text/javascript" src="{{ MEDIA_URL }}/js/jquery/jquery.tag-it.js"></script>
	<script type="text/javascript" src="{{ MEDIA_URL }}/js/jquery/jquery.tag-it.iecompat.js"></script>
	<script type="text/javascript" src="{{ MEDIA_URL }}/js/jquery/jquery.tinysort.js"></script>
	<script type="text/javascript" src="{{ MEDIA_URL }}/js/jquery/jquery.tagcloud.js"></script>

	<script type="text/javascript" src="{{ MEDIA_URL }}/js/jquery/jquery.ba-serializeobject.js"></script>
	<script type="text/javascript" src="{{ MEDIA_URL }}/js/jquery/jquery.dajax.core.js"></script>
	<script type="text/javascript" src="/js/dajax/dajaxice.core.js"></script>
	
	<!-- Scripts for Image Slider & Miniatures -->
	<script type="text/javascript" src="{{ MEDIA_URL }}/js/jquery/jquery.easing.1.2.js"></script>
	<script type="text/javascript" src="{{ MEDIA_URL }}/js/jquery/jquery.anythingslider.js" ></script>
	<script type="text/javascript" src="{{ MEDIA_URL }}/js/jquery/jquery.jcarousel.js"></script>
	<script type="text/javascript" src="{{ MEDIA_URL }}/js/swfobject.js" ></script>

	<!-- Scripts for Image Slider -->
	<script type="text/javascript">
	
		/* Update the carousel so that it matches the current picture  */
		function update_carousel(index) {
			var jcarousel = $('#project_photo_gallery_mini').data('jcarousel');
			
			console.debug(jcarousel.options.size);
			console.debug(jcarousel.options.scroll);
			if ( jcarousel.options.size > jcarousel.options.scroll )
				jcarousel.scroll(index - 1, true);
		}
	
	
		/* When a thumbnail is clicked */
		function changeslider(sid){
			var anyslider = $('#project_photo_gallery_current_photo');
			
			anyslider.anythingSlider(sid);
			update_carousel(sid);
					
			return false;
		};
	
		$(document).ready(function () {

			
			$('#project_photo_gallery_current_photo').find('embed[src*=youtube]').each(function(i){
				$(this).before('<param name="wmode" value="transparent">');
				$(this).attr('wmode', "transparent");
			});
			
			$('#project_photo_gallery_current_photo > iframe').css('z-index', '-2000');
			
			$('#project_photo_gallery_current_photo').anythingSlider({
				width : 700,          // Override the default CSS width
				height: 460,		// Override the default CSS height
				delay               : 10000,      // How long between slideshow transitions in AutoPlay mode (in milliseconds)
				animationTime       : 600,       // How long the slideshow transition takes (in milliseconds)
				buildArrows         : false,      // If true, builds the forwards and backwards buttons
				resizeContents      : true,      // If true, solitary images/objects in the panel will expand to fit the viewport
				autoPlay            : false,     // This turns off the entire slideshow FUNCTIONALY, not just if it starts running or not
				addWmodeToObject	: "transparent",
				easing: 'easeInOutExpo'
			});	
			
			/* Disable callbacks on the buttons to set a new behaviour */
			$('#project_photo_gallery_mini').jcarousel({buttonNextEvent: null, buttonPrevEvent: null, wrap: 'circular', scroll: 4});

			/* When the next button is clicked */
			$('.jcarousel-next').click(function() {
				var anyslider = $('#project_photo_gallery_current_photo').data('AnythingSlider');
						
				anyslider.goForward();
				update_carousel(anyslider.currentPage);
			});
			
			/* When the previous button is clicked */
			$('.jcarousel-prev').click(function() {
				var anyslider = $('#project_photo_gallery_current_photo').data('AnythingSlider');
				
				anyslider.goBack();
				update_carousel(anyslider.currentPage);
			});
			
		});
				


	</script>


  <script type="text/javascript">
    $(document).ready(function() {
	var tags = $("#themes_tags").tagit({
	    itemName: 'themes',
	});

	$("#themes_list").tagcloud({type:"sphere", sizemin:10, height: 200, colormin: "888888", colormax: "343434"}).find("li").tsort();

	$("#themes_list li").click(function($this) {
	    $.fn.tagit.create_tag($(this).text());
	});

	// restore tags in get
        {% if project_translation %}
          {% tags_for_object project_translation as project_tags %}
        	{% for tag in project_tags %}
	     $.fn.tagit.create_tag("{{ tag }}");
	  {% endfor %}
        {% endif %}

    });
  </script>


  <script type="text/javascript">
    function on_project_themes_updated(data) {
        if ( data == Dajaxice.EXCEPTION ) { alert('error'); }
        else {
           $('#opened-sidebar').slideToggle();
           location.reload();
        } 


    }

    function project_update_related() {
        //$('#search').block({message: 'Recherche en cours, patientez svp...'});
	//$('#search-results').fadeTo('fast', 0.3);
	//$('#search-results-wrapper').activity({width: 6, valign: 'center', padding: '20'});
        //$('#themes-form')

	themes_form = $('#themes-form').serializeObject(true);

        Dajaxice.apps.project_sheet.project_update_related(on_project_themes_updated, {'language_code': '{{ LANGUAGE_CODE }}',
                                                                                       'related_form': themes_form,
                                                                                       'project_slug': '{{ project_translation.slug }}'}
        );                                                          
	return false;
    }


  </script>

  <script type="text/javascript">
    $(document).ready(function() {

     /* FIXME: These two functions need to be merged somewhat */
     function edit_callback(value, settings) {
       var fieldname = $(this).prev('div').attr('id');

       Dajaxice.apps.project_sheet.project_sheet_edit_field(Dajax.process, {'fieldname': fieldname, 
                                                                            'value': value
                                                                            {% if project_translation %}, 'project_slug': '{{ project_translation.slug }}' {% endif %},
                                                                            'language_code': "{{ LANGUAGE_CODE }}"
       });

       $(this).removeClass('empty');


       $(this).hide().fadeIn()

       return(value);
     };

     function edit_about_callback(value, settings) {
       var fieldname = $(this).parent('div').attr('id');

       Dajaxice.apps.project_sheet.project_sheet_edit_field(Dajax.process, {'fieldname': fieldname, 
                                                                            'value': value
                                                                            {% if project_translation %}, 'project_slug': '{{ project_translation.slug }}' {% endif %},
                                                                            'language_code': "{{ LANGUAGE_CODE }}"
       });

       $(this).removeClass('empty');


       $(this).hide().fadeIn()

       return(value);
     };


     /* FIXME: This needs to be factorized */
     $('.project_description_txt').editable(edit_about_callback,
                                        {event: 'dblclick',
                                         tooltip: 'Double-click to edit',
                                         indicator: 'Saving...',
                                         type: 'textarea',
                                         height: '80px',
                                         width: '535px',
                                         cancel: "<input class='redbutton right nomargin' style='margin-left:4px;' type='image' src='{{ MEDIA_URL }}/images/base/x.png' alt='X'/>",
                                         submit: "<input class='greenbutton right nomargin' style='margin-left:4px;' type='image' src='{{ MEDIA_URL }}/images/base/v.png' alt='Ok'/>",
                                         onblur: 'ignore',
                                         cssclass: 'inline-edit',
                                         placeholder: "{% trans "This bloc is empty : don’t forget to fill it !"|capfirst %}"
                                         });



     $('.project_details_body').editable(edit_callback,
                                         {event: 'dblclick',
                                          tooltip: 'Double-click to edit',
                                          indicator: 'Saving...',
                                          type: 'textarea',
                                          height: '80px',
                                          width: '690px',
                                          cancel: "<input class='redbutton right nomargin' style='margin-left:4px;' type='image' src='{{ MEDIA_URL }}/images/base/x.png' alt='X'/>",
                                          submit: "<input class='greenbutton right nomargin' style='margin-left:4px;' type='image' src='{{ MEDIA_URL }}/images/base/v.png' alt='Ok'/>",
                                          onblur: 'ignore',
                                          cssclass: 'inline-edit',
                                          placeholder: "{% trans "This bloc is empty : don’t forget to fill it ! A good project is a complete project !"|capfirst %}"
                                          });

    $('.project_details_body').dblclick(function() {
      $('a.editing-button').fadeOut('fast');
    });

    $('.project_details_title_edit .button').click(function() {
      $(this).parent().next('.project_details_body').dblclick();
       return false;
    });

    /* FIXME: There must be a better to determine if we need to hide them or not */
    {% if project_translation %}
    // Hide buttons when their respecting section is not hover'ed
    $('a.editing-button').hide();
    $('a.editing-button').parent('div').hover(function() {
      $(this).find('a.editing-button').show();
    }, function() {
      $(this).find('a.editing-button').fadeOut('fast');
    });    
    {% endif %}
    
    });
  </script>


  <script type="text/javascript">
    /* FIXME: The animation is wrong, must be fixed ! */
    $(document).ready(function() {
      $('#opened-sidebar').hide();
      

      $('a.sidebar-opener').click(function() {
         $('#opened-sidebar').slideToggle();
         return false;
      });

      $('a.sidebar-close').click(function() {
         $('#opened-sidebar').slideToggle();
         return false;
      });

    });
  </script>

{% endblock %}

{% block project_content %}	
  <div class="grid_13 alpha project_content">

    <!-- PROJECT TITLE -->
    {% if title_form %}
      <!-- PROJECT TITLE - edition mode-->
      {% if project_translation %}
	<form id="title" action="{% url  project_sheet-instance-edit-field project_translation.slug 'title' %}" method="post">{% csrf_token %}
      {% else %}
	<form id="title" action="{% url project_sheet-edit-field 'title' %}" method="post">{% csrf_token %}
      {% endif %}
      {{title_form.title}}
      <input id="project_title_submit" type="submit" value="&nbsp;" />
	</form>

      {% else %}
	{% if project_translation %}
	  <!-- PROJECT TITLE - filled -->
	  <a href="{% url project_sheet-instance-edit-field project_translation.slug 'title' %}">
	    <div id="project_title">{{ project_translation.title }}</div>
	  </a>
	{% else %}
	  <!-- PROJECT TITLE - empty -->
	  <a href="{% url project_sheet-edit-field 'title' %}">
	    <div id="project_title_edit_inactive">{% trans 'my project title'|capfirst %}</div>
	  </a>
	{% endif %}
      {% endif %}
      

      <!-- BASELINE -->
      {% if baseline_form %}
	<!-- BASELINE - edition mode-->
	{% if project_translation %}

	  <form id="baseline" action="{% url project_sheet-instance-edit-field project_translation.slug 'baseline' %}" method="post" class="project_baseline_edition">{% csrf_token %}
	{% else %}
	  <form id="baseline" action="{% url project_sheet-edit-field 'baseline'%}" method="post" class="project_baseline_edition">{% csrf_token %}
	{% endif %}
	{{ baseline_form.baseline }}
	<input class="greenbutton" type="image"  src="{{ MEDIA_URL }}/images/base/v.png" alt="Ok" />
	<input class="redbutton" type="image" src="{{ MEDIA_URL }}/images/base/x.png" alt="X" />	
	</form>	
	{% else %}
	  {% if project_translation %}
	    <!-- BASELINE - filled-->
	    <div class="project_baseline focus">
	      <p>{{ project_translation.baseline }}</p>
	      <a href="{% url project_sheet-instance-edit-field project_translation.slug 'baseline' %}" class="button editing-button right"><img src="{{ MEDIA_URL }}/images/base/edit.png" /></a>
	    </div>
	  {% else %}
	    <!--  BASELINE - empty -->
	    <div class="project_baseline_edition_inactive">
	      <p>{% trans "my project baseline"|capfirst %}</p>
	      <a href="{% url project_sheet-edit-field 'baseline' %}" class="button editing-button"><img src="{{ MEDIA_URL }}/images/base/edit.png" alt="edit" /></a>
	    </div>
	  {% endif %}
	{% endif %}					
	
	<!-- PROJECT INFOS -->
	<div class="project_infos_bloc">
	  {% if project_translation %} 
	    <div class="creation_date">{{ project_translation.created }} {% trans 'by' %} 
	    <i>
	      {% if project_translation.author %}
		{{ project_translation.author.get_full_name_or_username }}
	      {% else %}
		{% trans 'anonymous'|capfirst %}
	      {% endif %}
	    </i>
	    ({{project_translation.ip_addr }})
	    </div>
	    <!--
		<div class="location">{{ project_translation.location }}</div>
	    -->
	  {% endif %}
	</div>
	
	{% include "media_gallery.html"%}
	
	<!-- PROJECT DESCRIPTION -->
	<div class="project_description">
	  {% include "about_section.html" %}
	</div>					
	

	<!-- PROJECT DETAILS -->
	<div class="project_details">
	  {% include "uniqueness_section.html" %}
	  
	  {% include "value_section.html" %}
	  
	  {% include "scalability_section.html" %}
	  
	</div>
	

	<div class="clear"></div>

	<div id="license-note">
	  {% blocktrans %}
	    This project sheet, except media, is licensed under the <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons CC-BY-SA 3.0</a> <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/"><img alt="Contrat Creative Commons" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/80x15.png" /></a>
	  {% endblocktrans %}
	</div>
	
      </div>
      
      <!-- GREY COLUMN - closed (default) -->
      <div class="grid_5 omega grey_column">											
	<div class="grey_column_content">					
	  
	  {% if project_translation %}
	    <div class="title">
	      <a href="{% url project_sheet-instance-edit-related project_translation.slug %}" class="button sidebar-opener"><img src="{{ MEDIA_URL }}/images/base/edit.png" alt="edit" /></a>{% trans 'Related'|capfirst %}
	    </div>

	    <!-- Colonne grise remplie -->
	    <div class="grey_column_objective">	
	      <label>{% trans 'Objective :'|capfirst %}</label> 
	      <a href="#" id="project_objective">{{ project_translation.project.get_objective_display }}</a>
	    </div>

	    {% if not project_translation.themes %}
	      <p>
		<a class="sidebar-opener" href="#">{% trans "Click here to set the <strong>objective</strong> and the <strong>themes</strong> of your project."|capfirst %}</a>
	      </p>
	    {% else %}

	      {% tags_for_object project_translation as taglist %}
		<div class="grey_column_tagcloud">	
		  <label>{% trans 'Themes:'|capfirst %}</label> 							
		  <ul id="cloudtag_list">
		    {% for tag in taglist %}
		      <li><a href="#">{{ tag }}</a>{% if not forloop.last %},{% endif %}</li>
		    {% endfor %}
		  </ul>
		</div>

	    {% endif %}

	    <div class="clear"></div>
	    
	    {% trans "Available versions:" %}
	    <ul id="translations">
	    {% for translation in project_translation.project.translations.all %}
	      <li><a href="{% locale_url translation.language_code project_sheet-show translation.slug %}">{{ translation.language_code }} </a></li>
	      {% endfor %}
	    </ul>

	    {% trans "Create a translation in:" %}

	    <form method='POST' action='{% url project_sheet-translate project_translation.slug %}'>
	      {% csrf_token %}
	      <select name="language_code">
		{% for language in LANGUAGES %}
		  <option value="{{ language.0 }}">{{ language.1 }}</option>
		{% endfor %}
	      </select>
	      <button type="submit">{% trans 'Create' %}</button>
	    </form>


	  {% else %}
	    <h1>{% trans "How to start your project sheet ?" %}</h1>
	    {% trans "Click on a field to edit it, then submit your changes. Your project will be created once a field is filled." %}
	  {% endif %}
	</div>					
      </div>	

      <!-- GREY COLUMN - opened -->
      <div id="opened-sidebar" class="grid_12 omega grey_column_open">	
	<div class="grey_column_content">	
	  
	  <div class="title">{% trans 'Related'|capfirst %}</div>

	  <form id="themes-form" method="POST">

	  <div class="grey_column_content_edition">
	    
	    <div class="grey_column_objective_edition">						
	      <form action="#" method="#">
		<p>
		  <label>{% trans 'Objective :'|capfirst %}</label> 
		  {{ project_objective_form.objective }}
		</p>
	      </form>						
	    </div>						
	    
	    <div class="grey_column_cloudtag_edition">
	      
		<div id="grey_column_cloudtag_edition_title">
		  <label>{% trans 'Themes:'|capfirst %}</label><span class="precision">({% trans 'select your tags from the cloud below' %})</span>
		</div>
		
		<ul id="themes_list">
		  {% tags_for_model project_sheet.I4pProjectTranslation as project_sheet_tags with counts %}
		    
		    {% for tag in project_sheet_tags %}
		      <li value="{{ tag.count }}"><a href="javascript:;">{{ tag }}</a></li>
		    {% endfor %}
		</ul>
		
		<ul id="themes_tags">
		</ul>

	    </div>

	    <a id="grey_column_close" class="sidebar-close" href="javascript:;">{% trans 'Close & discard'%}</a>
	    <a href="javascript:;" onclick="javascript: return project_update_related();" id="grey_column_save_close">{% trans 'Save & close'%}</a>

	  </form>
	</div>
	  
      </div>					

    </div>					

{% endblock %}